# Babble 设计文档

macOS 原生语音输入工具

## 项目定位

Babble 是一个 macOS 原生语音输入工具，目标是在任何应用中替代键盘输入。核心特点：

- **MLX Whisper Turbo** 本地语音识别，隐私优先
- **Apple Foundation Model (3B)** 本地文本润色
- **粘贴式输入** 兼容所有应用

## 系统要求

- macOS 26.0+（AFM 要求）
- Apple Silicon（MLX 要求）
- 约 2GB 磁盘空间（含 Whisper 模型）

## 系统架构

```
┌─────────────────────────────────────────────────┐
│              Babble.app (Swift/SwiftUI)         │
│  ┌──────────┐ ┌──────────┐ ┌────────────────┐   │
│  │ 菜单栏   │ │ 悬浮窗   │ │    主窗口      │   │
│  │ 入口     │ │ 状态指示 │ │ 设置/历史/编辑 │   │
│  └──────────┘ └──────────┘ └────────────────┘   │
│                     │                           │
│           ┌─────────┴─────────┐                 │
│           │  AFM Refine 模块  │                 │
│           └───────────────────┘                 │
└─────────────────────┬───────────────────────────┘
                      │ HTTP (localhost)
┌─────────────────────┴───────────────────────────┐
│        babble-whisper-service (Python)          │
│     MLX Whisper Turbo · 按需启动 · 自动休眠     │
└─────────────────────────────────────────────────┘
```

## 仓库结构

```
babble/
├── BabbleApp/          # Swift 主应用
├── whisper-service/    # Python MLX 服务
├── docs/               # 文档
└── scripts/            # 构建、打包脚本
```

## 用户交互

### 触发方式

多种触发方式（均可自定义开关）：

| 类型 | 示例 | 说明 |
|------|------|------|
| **键盘快捷键** | `⌥ Space`、`Fn Fn` 等 | 传统方式，可自定义组合 |
| **触摸板手势** | 四指长按、三指双击 | 需要辅助功能权限 |
| **触摸板热区** | 右下角长按 | 手指放在角落触发 |
| **鼠标按键** | 侧键长按 | 适合有多键鼠标的用户 |

### 触发模式

| 操作 | 行为 |
|------|------|
| **长按** | 对讲机模式：按住说话，松开结束并处理 |
| **短按** | 切换模式：按一次开始录音，再按一次结束 |

### 录音状态反馈（悬浮窗）

悬浮窗在录音时出现，显示：
- 录音状态指示（录音中 / 处理中 / 完成）
- 音量波形 — 实时反馈麦克风收到声音
- 录音时长

位置：屏幕顶部居中或跟随光标（可配置）

### 输入流程

```
用户触发 → 开始录音 → 悬浮窗显示
    ↓
结束录音 → 发送音频到 Whisper 服务
    ↓
收到转写 → 根据设置决定是否 Refine
    ↓
   直接输出          │        调用 AFM Refine
       ↓            │              ↓
       └──────┬─────┴──────────────┘
              ↓
    写入剪贴板 → 模拟 ⌘V 粘贴 → 保存到历史
```

## Refine 模式

用户可预设或临时切换：

| 模式 | Prompt 策略 |
|------|------------|
| **关闭** | 直接使用 Whisper 原始输出 |
| **纠错** | 修正语音转写中的明显错误，保持原意和口吻 |
| **标点** | 修正错误并优化标点符号，保持原意 |
| **润色** | 将口语转为通顺的书面表达，保持原意 |

高级设置中允许用户：
- 修改内置模式的 prompt
- 创建自定义模式（如"翻译成英文"、"转为正式邮件语气"）

## 历史记录与编辑

### 历史列表

主窗口中显示转写历史，每条记录包含：

| 字段 | 说明 |
|------|------|
| 时间戳 | 录音时间 |
| 原始文本 | Whisper 直出结果 |
| Refine 文本 | AFM 处理后的版本（如有） |
| 使用的模式 | 纠错 / 标点 / 润色 |
| 目标应用 | 粘贴到了哪个应用（可选记录） |

### 对比视图

选中一条记录后，并排显示：

```
┌─────────────────┬─────────────────┐
│   原始转写      │   Refine 结果   │
│                 │                 │
│ "那个我觉得这个 │ "我觉得这个方案 │
│  方案不行啊"    │  不太可行。"    │
│                 │                 │
│   [使用此版本]  │   [使用此版本]  │
└─────────────────┴─────────────────┘
              [编辑后使用]
```

### 编辑功能

- 点击「编辑后使用」进入编辑模式
- 可基于原始或 Refine 版本修改
- 编辑后点击「粘贴」写入剪贴板并模拟粘贴
- 编辑过的版本也保存到历史（标记为"已编辑"）

### 快捷操作

- `⌘ C` — 复制选中版本到剪贴板（不粘贴）
- `Enter` — 使用 Refine 版本粘贴
- `⇧ Enter` — 使用原始版本粘贴
- 支持搜索历史记录

## MLX Whisper 服务

### 目录结构

```
whisper-service/
├── server.py           # FastAPI 服务入口
├── transcribe.py       # MLX Whisper 调用封装
├── requirements.txt    # mlx-whisper, fastapi, uvicorn 等
└── config.yaml         # 模型配置、端口等
```

### API 设计

```
POST /transcribe
Content-Type: multipart/form-data

参数:
  - audio: 音频文件 (wav/m4a)
  - language: 语言代码，默认 "zh"（可选）

响应:
{
  "text": "识别出的文本",
  "segments": [...],      // 分段信息（可选）
  "duration": 3.2,        // 音频时长
  "processing_time": 0.8  // 处理耗时
}
```

```
GET /health
响应: { "status": "ready", "model": "whisper-large-v3-turbo" }
```

### 生命周期管理

| 状态 | 行为 |
|------|------|
| **冷启动** | 主 App 首次调用时拉起，加载模型约 3-5 秒 |
| **热待机** | 模型常驻内存，响应 < 1 秒 |
| **自动休眠** | 空闲 N 分钟后卸载模型释放显存，进程保留 |
| **完全退出** | 主 App 退出时或手动关闭 |

设置项：休眠时间（默认 5 分钟）、是否随主 App 启动预热

## AFM Refine 模块

### 集成方式

直接在主 App 中使用 Apple Foundation Model API（需 macOS 26+）。

```swift
import FoundationModels

class RefineService {
    let session: LanguageModelSession

    func refine(text: String, mode: RefineMode) async -> String
}
```

### 性能预期

- Apple 3B 模型在 M 系列芯片上响应较快
- 短文本（< 100 字）预计 < 1 秒
- 提供"跳过 Refine"选项应对偶尔的延迟

### 降级处理

若 AFM 不可用（系统版本、模型未下载等）：
- 提示用户，提供下载指引
- 自动降级为"仅转写"模式

## 主 App 模块结构

```
BabbleApp/
├── App/
│   ├── BabbleApp.swift          # 入口
│   └── AppDelegate.swift        # 菜单栏、全局快捷键注册
├── Features/
│   ├── Recording/               # 录音控制、音频捕获
│   ├── Transcription/           # 调用 Whisper 服务
│   ├── Refine/                  # AFM 调用
│   ├── Paste/                   # 剪贴板 + 模拟粘贴
│   └── History/                 # 历史存储与查询
├── UI/
│   ├── MenuBar/                 # 菜单栏组件
│   ├── FloatingPanel/           # 悬浮状态窗
│   ├── MainWindow/              # 主窗口（设置、历史）
│   └── Components/              # 共享组件
└── Services/
    ├── HotkeyManager.swift      # 快捷键/手势监听
    ├── WhisperClient.swift      # HTTP 客户端
    └── ProcessManager.swift     # 管理 Whisper 服务进程
```

## 设置项

| 分类 | 项目 |
|------|------|
| **触发** | 快捷键配置、触摸板手势、鼠标按键、热区 |
| **转写** | 默认语言、Whisper 服务端口 |
| **Refine** | 默认模式、自定义 Prompt、是否自动 Refine |
| **输出** | 粘贴后是否自动清空剪贴板、通知音效 |
| **历史** | 保留条数上限、是否记录目标应用 |
| **性能** | 服务休眠时间、是否预热启动 |
| **通用** | 开机启动、菜单栏图标样式 |

## 权限需求

首次启动引导用户授权：
- **麦克风** — 录音必需
- **辅助功能** — 全局快捷键、手势监听、模拟粘贴

## 安装流程

```
安装 Babble.app (~50MB)
       ↓
首次启动
       ↓
┌──────────────────────────────────────┐
│  检测环境                            │
│  ├─ Python 3.10+ ?                   │
│  │   └─ 无 → 引导安装                │
│  ├─ MLX 依赖 ?                       │
│  │   └─ 无 → 自动 pip install        │
│  └─ Whisper 模型 ?                   │
│      └─ 无 → 下载 (~1.5GB)           │
└──────────────────────────────────────┘
       ↓
     就绪
```

### 模型管理

- **默认模型** — `mlx-community/whisper-large-v3-turbo`（~1.5GB）
- **存储位置** — `~/.cache/huggingface/` 或 `~/Library/Application Support/Babble/models/`
- **下载进度** — 主窗口显示进度条
- **可选模型** — 设置中提供其他尺寸选项（small、medium），用户可按需切换

## 构建与发布

### 构建脚本

```
scripts/
├── build-app.sh          # 构建 Swift 主 App
├── build-service.sh      # 打包 Python 服务（含依赖）
├── package.sh            # 组合成 .dmg 安装包
└── dev.sh                # 开发模式启动
```

### 开源发布

- 许可证：MIT
- 提供 Homebrew Cask 安装
- GitHub Releases 发布 .dmg
- README 包含：功能介绍、安装方式、构建指南、贡献指南
